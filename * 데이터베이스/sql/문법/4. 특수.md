# SQL 특수 고급 기능
#Database/SQL #SQL/SpecialFeatures

> [!INFO]
> 이 문서는 데이터베이스의 성능, 안정성, 보안을 최고 수준으로 관리하기 위한 특수 기능들을 다룹니다. 잠금, 쿼리 최적화, 복제, 감사 등 DBA(데이터베이스 관리자)의 영역에 가까운 고급 주제를 포함합니다.

## 1. 잠금(Lock) 관리

> [!NOTE] 잠금(Lock)
> 여러 트랜잭션이 동일한 데이터에 동시에 접근하여 발생하는 문제를 막기 위한 메커니즘입니다.

-   **명시적 잠금**: 개발자가 직접 특정 데이터나 테이블에 잠금을 거는 기능입니다.
    -   **행 잠금 (Row-level Lock)**: 특정 행에만 잠금을 겁니다. 동시성 확보에 유리합니다.
        ```sql
        -- 다른 트랜잭션이 이 행을 수정하지 못하도록 배타적 잠금을 설정
        SELECT * FROM my_table WHERE id = 1 FOR UPDATE;

        -- 다른 트랜잭션이 이 행에 공유 잠금을 거는 것은 허용하지만, 수정은 막음
        SELECT * FROM my_table WHERE id = 1 LOCK IN SHARE MODE;
        ```
    -   **테이블 잠금 (Table-level Lock)**: 테이블 전체에 잠금을 겁니다.
        ```sql
        LOCK TABLES my_table WRITE; -- 쓰기 잠금
        UNLOCK TABLES; -- 잠금 해제
        ```
-   **잠금 상태 확인**: 현재 잠금 상태나 잠금 대기(Lock Wait) 상태를 모니터링합니다.
    ```sql
    -- InnoDB 잠금 대기 상태 확인
    SELECT * FROM information_schema.INNODB_LOCK_WAITS;
    ```

## 2. 쿼리 최적화 기법

-   **쿼리 힌트 (Query Hints)**: 옵티마이저가 최적의 실행 계획을 세우지 못할 때, 개발자가 직접 인덱스 사용이나 조인 순서 등을 강제하는 방법입니다.
    ```sql
    -- idx_name 인덱스를 사용하도록 힌트 제공
    SELECT /*+ INDEX(my_table idx_name) */ *
    FROM my_table
    WHERE condition;
    ```
-   **통계 정보 관리**: 옵티마이저는 테이블의 데이터 분포도(통계 정보)를 기반으로 실행 계획을 세웁니다. 데이터에 큰 변화가 생겼을 때 통계 정보를 수동으로 갱신하면 쿼리 성능이 향상될 수 있습니다.
    ```sql
    ANALYZE TABLE my_table;
    ```

## 3. 백업 및 복제 (Backup & Replication)

-   **온라인 백업**: 서비스 중단 없이 백업을 수행하기 위한 기능입니다.
-   **증분 백업 (Incremental Backup)**: 전체 백업 이후 변경된 부분만 추가로 백업하여 백업 시간과 용량을 줄입니다.
-   **복제 (Replication)**: 원본(Master) 데이터베이스의 변경 사항을 복사본(Slave/Replica) 데이터베이스에 실시간으로 동기화하는 기술입니다. 부하 분산(읽기/쓰기 분리)이나 고가용성(HA) 확보를 위해 사용됩니다.
    ```sql
    -- 복제 상태 확인
    SHOW SLAVE STATUS\G
    ```

## 4. 감사 (Audit)

> [!NOTE] 감사(Audit)
> 누가, 언제, 어떤 데이터에 접근하여 무슨 작업을 했는지 기록을 남기는 기능입니다. 보안 및 규정 준수를 위해 중요합니다.

```sql
-- 모든 활동에 대한 감사 로그 활성화
SET GLOBAL audit_log_policy = 'ALL';

-- 특정 데이터베이스에 대한 감사 필터 설정
SET GLOBAL audit_log_filter = 'database=test';
```

## 5. 고급 인덱스 기능

-   **함수 기반 인덱스 (Function-based Index)**: 컬럼 값 자체 대신, 특정 함수나 표현식을 적용한 결과에 대해 인덱스를 생성합니다.
    ```sql
    -- 이메일 주소를 모두 대문자로 변환한 결과에 대해 인덱스 생성
    CREATE INDEX idx_upper_email ON users ((UPPER(email)));
    ```
-   **부분 인덱스 (Partial Index)**: 테이블의 특정 부분(조건을 만족하는 행)에 대해서만 인덱스를 생성하여 인덱스 크기를 줄이고 효율을 높입니다.
    ```sql
    -- 활성 사용자(status = 'active')의 로그인 기록에 대해서만 인덱스 생성
    CREATE INDEX idx_active_users ON users (last_login) WHERE status = 'active';
    ```

## 6. 고급 쿼리 패턴

-   **계층적 쿼리 (Hierarchical Query)**: `WITH RECURSIVE`를 사용하여 조직도, 카테고리 등 계층 구조 데이터를 효과적으로 조회합니다.
-   **피벗 테이블 (Pivot Table)**: 행 데이터를 열 데이터로 전환하여 보고서나 통계를 만들기 용이한 형태로 데이터를 재구성합니다.
    ```sql
    -- category 값을 컬럼으로 전환하는 동적 피벗 테이블 예시
    SELECT
        date,
        MAX(CASE WHEN category = 'Electronics' THEN amount END) AS Electronics,
        MAX(CASE WHEN category = 'Books' THEN amount END) AS Books
    FROM sales
    GROUP BY date;
    ```

---
> [[00. 데이터베이스 목차.md|⬆️ 목차로 돌아가기]]
> [[3. 심화.md|⬅️ 이전: 3. 심화]] | [[5. 최종고급.md|➡️ 다음: 5. 최종고급]]
# SQL 심화 문법
#Database/SQL #SQL/DeepDive

> [!INFO]
> 이 문서는 일반적인 CRUD를 넘어, 대용량 데이터 처리, 자동화, 보안 등 데이터베이스를 보다 전문적으로 관리하고 활용하기 위한 심화 기능들을 다룹니다.

## 1. 동적 SQL (Prepared Statements)

> [!NOTE] 동적 SQL
> 쿼리 템플릿을 미리 만들어두고, 실행 시점에 파라미터만 바꿔서 실행하는 방식입니다. SQL Injection 공격을 방어하고, 동일한 쿼리의 반복 실행 성능을 높여줍니다.

```sql
-- 1. 쿼리 템플릿 준비 (PREPARE)
PREPARE stmt FROM 'SELECT * FROM users WHERE id = ?';

-- 2. 변수 설정 (SET)
SET @id = 1;

-- 3. 실행 (EXECUTE)
EXECUTE stmt USING @id;

-- 4. 준비된 구문 해제 (DEALLOCATE)
DEALLOCATE PREPARE stmt;
```

## 2. 파티셔닝 (Partitioning)

> [!NOTE] 파티셔닝
> 매우 큰 테이블을 특정 기준(날짜, 범위 등)에 따라 여러 개의 작은 물리적 단위(파티션)로 분할하여 관리하는 기법입니다. 쿼리 시 불필요한 파티션을 제외하고 필요한 부분만 탐색하여 성능을 크게 향상시킬 수 있습니다.

-   **`RANGE` 파티셔닝**: 날짜나 숫자처럼 연속적인 값의 범위에 따라 분할합니다.
    ```sql
    CREATE TABLE sales ( ... )
    PARTITION BY RANGE (YEAR(sale_date)) (
        PARTITION p0 VALUES LESS THAN (2022),
        PARTITION p1 VALUES LESS THAN (2023),
        PARTITION p2 VALUES LESS THAN (2024)
    );
    ```
-   **`LIST` 파티셔닝**: 특정 값 목록에 따라 분할합니다. (예: 국가 코드, 부서명)
-   **`HASH` 파티셔닝**: 해시 함수를 사용하여 데이터를 여러 파티션에 고르게 분산시킵니다.

## 3. 저장 프로시저와 함수

> [!NOTE] 저장 프로시저 & 함수
> 여러 SQL 문장들을 하나의 논리적 단위로 묶어 데이터베이스에 저장해두고, 필요할 때마다 호출하여 사용하는 기능입니다. 복잡한 로직을 서버에 위임하여 네트워크 부하를 줄이고 재사용성을 높입니다.

-   **사용자 정의 함수 (UDF)**
    ```sql
    DELIMITER //
    CREATE FUNCTION calculate_age(birth_date DATE)
    RETURNS INT
    DETERMINISTIC
    BEGIN
        RETURN YEAR(CURDATE()) - YEAR(birth_date);
    END //
    DELIMITER ;
    ```
-   **커서 (Cursor)**: 프로시저 내에서 쿼리 결과를 한 행씩 순회하며 복잡한 로직을 처리할 때 사용합니다.

## 4. 전문 검색 (Full-Text Search)

> [!NOTE] 전문 검색
> 일반적인 `LIKE` 검색보다 훨씬 빠르고 정교하게 긴 텍스트 내용에서 단어나 구문을 검색하는 기능입니다. 블로그 본문, 상품 설명 등 텍스트 검색에 특화되어 있습니다.

-   **전문 검색 인덱스 생성**
    ```sql
    CREATE TABLE articles (
        id INT PRIMARY KEY,
        title VARCHAR(200),
        content TEXT,
        FULLTEXT INDEX ft_content (content)
    );
    ```
-   **검색 쿼리 (`MATCH` ... `AGAINST`)**
    ```sql
    -- 자연어 검색
    SELECT * FROM articles
    WHERE MATCH(content) AGAINST('database performance' IN NATURAL LANGUAGE MODE);

    -- 불리언 모드 검색 (필수, 제외 등 연산자 사용)
    SELECT * FROM articles
    WHERE MATCH(content) AGAINST('+database -oracle' IN BOOLEAN MODE);
    ```

## 5. 이벤트 스케줄러

> [!NOTE] 이벤트 스케줄러
> 지정된 시간에 특정 SQL 작업을 자동으로 실행하도록 예약하는 기능입니다. (리눅스의 `cron`과 유사)

```sql
-- 매일 자정에 30일이 지난 로그를 삭제하는 이벤트 생성
CREATE EVENT delete_old_logs
ON SCHEDULE EVERY 1 DAY
STARTS '2024-01-01 00:00:00'
DO
    DELETE FROM logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

## 6. 역할 기반 권한 관리 (Role-Based Access Control)

> [!NOTE] 역할(Role)
> 여러 권한의 묶음을 '역할'로 만들어두고, 사용자에게는 해당 역할을 부여하여 권한을 관리하는 방식입니다. 사용자 개개인이 아닌 역할 중심으로 권한을 관리하여 편의성과 보안성을 높입니다.

```sql
-- 1. 역할 생성
CREATE ROLE 'app_read', 'app_write';

-- 2. 역할에 권한 부여
GRANT SELECT ON my_db.* TO 'app_read';
GRANT INSERT, UPDATE, DELETE ON my_db.* TO 'app_write';

-- 3. 사용자에게 역할 부여
CREATE USER 'user1'@'localhost' IDENTIFIED BY 'password';
GRANT 'app_read' TO 'user1'@'localhost';
```

---
> [[00. 데이터베이스 목차.md|⬆️ 목차로 돌아가기]]
> [[2. 고급.md|⬅️ 이전: 2. 고급]] | [[4. 특수.md|➡️ 다음: 4. 특수]]
# SQL 최종 고급 기능
#Database/SQL #SQL/Expert

> [!INFO]
> 이 문서는 데이터베이스의 내부 동작 원리와 깊이 연관된 최고 수준의 관리 및 최적화 기법을 다룹니다. 메모리 관리, 데이터 암호화, 고급 복제 및 시스템 진단 등 주로 대용량 프로덕션 환경의 DBA(데이터베이스 관리자)가 다루는 주제를 포함합니다.

## 1. 메모리 최적화 기법

> [!NOTE] 메모리 최적화
> 쿼리 성능은 디스크 I/O를 얼마나 줄이고 메모리를 효율적으로 사용하느냐에 따라 크게 좌우됩니다.

-   **버퍼 풀 관리 (Buffer Pool)**: InnoDB 스토리지 엔진이 데이터와 인덱스를 캐시하는 핵심 메모리 공간입니다.
    ```sql
    -- 버퍼 풀의 크기를 4GB로 설정
    SET GLOBAL innodb_buffer_pool_size = 4G;

    -- 버퍼 풀 상태 상세 확인
    SHOW ENGINE INNODB STATUS;
    ```
-   **메모리 테이블 활용**: 자주 접근하지만 자주 변경되지 않는 데이터를 메모리 스토리지 엔진을 사용하는 테이블에 저장하여 디스크 접근을 원천적으로 차단하고 성능을 극대화할 수 있습니다.
    ```sql
    CREATE TABLE cache_table (
        id INT PRIMARY KEY,
        data VARCHAR(100)
    ) ENGINE = MEMORY;
    ```

## 2. 고급 데이터 암호화

> [!NOTE] 데이터 암호화
> 데이터베이스에 저장된 데이터를 암호화하여 비인가자의 접근으로부터 민감한 정보를 보호합니다.

-   **TDE (Transparent Data Encryption)**: 데이터베이스가 디스크에 데이터를 쓸 때 자동으로 암호화하고, 읽을 때 자동으로 복호화하는 방식입니다. 애플리케이션 수정이 필요 없습니다.
    -   **테이블스페이스 암호화**: 특정 테이블스페이스 전체를 암호화합니다.
        ```sql
        CREATE TABLESPACE encrypted_ts ADD DATAFILE 'encrypted_ts.ibd' ENCRYPTION = 'Y';
        CREATE TABLE secure_data (...) TABLESPACE encrypted_ts;
        ```
-   **필드 레벨 암호화**: 특정 컬럼의 데이터만 애플리케이션 레벨 또는 DB 함수를 통해 암호화합니다.
    ```sql
    -- AES 함수를 사용한 데이터 암호화/복호화
    INSERT INTO users_secure (password, credit_card) VALUES
        (AES_ENCRYPT('my_password', @key), AES_ENCRYPT('1234-5678', @key));

    SELECT AES_DECRYPT(credit_card, @key) FROM users_secure;
    ```

## 3. 고급 파티셔닝 기법

-   **서브파티셔닝 (Subpartitioning)**: 파티션으로 나뉜 데이터를 다시 다른 기준으로 재분할하는 기법입니다. 예를 들어, 날짜(RANGE)로 먼저 나누고, 다시 지역(LIST)으로 나누어 더 세밀하게 데이터를 관리할 수 있습니다.
    ```sql
    CREATE TABLE sales_data ( ... )
    PARTITION BY RANGE (YEAR(sale_date))
    SUBPARTITION BY HASH (id)
    SUBPARTITIONS 4 (
        PARTITION p2023 VALUES LESS THAN (2024),
        PARTITION p2024 VALUES LESS THAN (2025)
    );
    ```

## 4. 고급 복제 기술 (Replication)

-   **다중 소스 복제 (Multi-Source Replication)**: 여러 개의 마스터 데이터베이스로부터 하나의 슬레이브가 데이터를 복제받는 구조입니다. 여러 서비스의 데이터를 한 곳으로 모아 분석할 때 유용합니다.
-   **병렬 복제 (Parallel Replication)**: 슬레이브가 마스터의 변경 로그를 여러 스레드를 사용하여 병렬로 적용하여 복제 지연(Replication Lag)을 최소화하는 기술입니다.

## 5. 시스템 진단 및 모니터링

-   **성능 스키마 (Performance Schema)**: 데이터베이스 서버의 내부 동작에 대한 상세한 성능 데이터를 수집하고 조회할 수 있는 강력한 도구입니다.
    ```sql
    -- 대기 이벤트(Wait Event) 분석을 통해 I/O 병목 지점 찾기
    SELECT event_name, COUNT_STAR, SUM_TIMER_WAIT
    FROM performance_schema.events_waits_summary_global_by_event_name
    WHERE event_name LIKE 'wait/io/file/%'
    ORDER BY SUM_TIMER_WAIT DESC;
    ```
-   **프로파일링 (Profiling)**: 특정 쿼리가 실행될 때 각 단계에서 소요된 시간을 측정하여 병목 구간을 상세하게 분석합니다.
    ```sql
    SET profiling = 1;
    -- ... 쿼리 실행 ...
    SHOW PROFILES;
    SHOW PROFILE FOR QUERY [query_id];
    ```

## 6. 시점 복구 (Point-in-Time Recovery, PITR)

> [!NOTE] 시점 복구
> 데이터베이스를 특정 과거 시점으로 정확하게 되돌리는 기능입니다. 실수로 데이터를 삭제하거나 잘못 변경했을 때 데이터를 복구하기 위한 필수 기능입니다. 바이너리 로그(Binary Log)가 활성화되어 있어야 합니다.

---
> [[00. 데이터베이스 목차.md|⬆️ 목차로 돌아가기]]
> [[4. 특수.md|⬅️ 이전: 4. 특수]]
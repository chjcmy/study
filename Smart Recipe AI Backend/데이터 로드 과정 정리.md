# Smart Recipe AI Backend - ë°ì´í„° ë¡œë“œ ê³¼ì • ì •ë¦¬

## ğŸ“š ëª©ì°¨
1. [[#í”„ë¡œì íŠ¸ ê°œìš”]]
2. [[#ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •]]
3. [[#CSV ë°ì´í„° ë¶„ì„]]
4. [[#ë°ì´í„° ë¡œë“œ ê³¼ì •]]
5. [[#ìµœì¢… ê²°ê³¼]]
6. [[#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…]]

---

## ğŸ¯ í”„ë¡œì íŠ¸ ê°œìš”

### ëª©í‘œ
- RAW_recipes.csv (231,637ê°œ ë ˆì‹œí”¼)ì™€ allergen_ultra_clean.csv (15,244ê°œ ì¬ë£Œ) ë°ì´í„°ë¥¼ MongoDBì™€ Elasticsearchì— ì™„ì „ ë¡œë“œ
- AI ê¸°ë°˜ ë ˆì‹œí”¼ ì¶”ì²œ ì‹œìŠ¤í…œì„ ìœ„í•œ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¶•

### ì‹œìŠ¤í…œ êµ¬ì„±
- **Backend**: NestJS (í¬íŠ¸ 3001)
- **Database**: MongoDB (192.168.0.111:27017)
- **Search Engine**: Elasticsearch (192.168.0.111:9200)
- **Cache**: Redis (192.168.0.111:6379)

---

## ğŸ—ƒï¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •

### MongoDB ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
```bash
mongosh --host 192.168.0.111:27017 --username recipe_admin --password 'RecipeDB_2024_Secure#9x7!' --authenticationDatabase admin

use recipe_ai_db
db.createUser({
  user: "recipe_admin",
  pwd: "RecipeDB_2024_Secure#9x7!",
  roles: [
    { role: "readWrite", db: "recipe_ai_db" },
    { role: "dbAdmin", db: "recipe_ai_db" }
  ]
})
```

### MongoDB ì»¬ë ‰ì…˜ ì¸ë±ìŠ¤ ì„¤ì •
```bash
// Users ì»¬ë ‰ì…˜ ì¸ë±ìŠ¤
db.users.createIndex({ "email": 1 }, { unique: true })
db.users.createIndex({ "username": 1 }, { unique: true })

// Recipes ì»¬ë ‰ì…˜ ì¸ë±ìŠ¤
db.recipes.createIndex({ "id": 1 }, { unique: true })
db.recipes.createIndex({ "name": "text", "description": "text", "ingredients": "text" })
db.recipes.createIndex({ "category": 1 })
db.recipes.createIndex({ "difficulty": 1 })

// Ingredients ì»¬ë ‰ì…˜ ì¸ë±ìŠ¤
db.ingredients.createIndex({ "ingredient_name": "text" })

// VectorMetadata ì»¬ë ‰ì…˜ ì¸ë±ìŠ¤
db.vectormetadatas.createIndex({ "vectorId": 1 }, { unique: true })
db.vectormetadatas.createIndex({ "recipe_id": 1 })

// ChatHistory ì»¬ë ‰ì…˜ ì¸ë±ìŠ¤
db.chathistories.createIndex({ "user": 1 })
db.chathistories.createIndex({ "createdAt": -1 })
```

---

## ğŸ“Š CSV ë°ì´í„° ë¶„ì„

### allergen_ultra_clean.csv êµ¬ì¡°
- **ì´ í–‰ìˆ˜**: 15,244ê°œ
- **ì»¬ëŸ¼ìˆ˜**: 21ê°œ
- **ì£¼ìš” í•„ë“œ**:
  - `ingredient_name`: ì¬ë£Œëª…
  - 19ê°€ì§€ ì•Œë ˆë¥´ê¸° ì •ë³´ (0/1 í”Œë˜ê·¸):
    - ê¸€ë£¨í…í•¨ìœ ê³¡ë¬¼, ê°‘ê°ë¥˜, ë‚œë¥˜, ì–´ë¥˜, ë•…ì½©, ëŒ€ë‘, ìš°ìœ , ê²¬ê³¼ë¥˜
    - ì…€ëŸ¬ë¦¬, ê²¨ì, ì°¸ê¹¨, ì•„í™©ì‚°ë¥˜, ë£¨í•€, ì—°ì²´ë™ë¬¼, ë³µìˆ­ì•„, í† ë§ˆí† 
    - ë¼ì§€ê³ ê¸°, ì‡ ê³ ê¸°, ë‹­ê³ ê¸°
  - `note`: ì¶”ê°€ ì„¤ëª…

### RAW_recipes.csv êµ¬ì¡°
- **ì´ í–‰ìˆ˜**: 267,783ê°œ (í—¤ë” í¬í•¨)
- **ì‹¤ì œ ë ˆì‹œí”¼**: 231,637ê°œ
- **ì£¼ìš” í•„ë“œ**:
  - `name`: ë ˆì‹œí”¼ëª…
  - `id`: ê³ ìœ  ID
  - `minutes`: ì¡°ë¦¬ì‹œê°„
  - `contributor_id`: ê¸°ì—¬ì ID
  - `submitted`: ì œì¶œì¼
  - `tags`: íƒœê·¸ ëª©ë¡ (JSON ë°°ì—´)
  - `nutrition`: ì˜ì–‘ì •ë³´ (JSON ë°°ì—´)
  - `n_steps`: ì¡°ë¦¬ ë‹¨ê³„ ìˆ˜
  - `steps`: ì¡°ë¦¬ ë‹¨ê³„ (JSON ë°°ì—´)
  - `description`: ì„¤ëª…
  - `ingredients`: ì¬ë£Œ ëª©ë¡ (JSON ë°°ì—´)
  - `n_ingredients`: ì¬ë£Œ ìˆ˜

---

## ğŸ”„ ë°ì´í„° ë¡œë“œ ê³¼ì •

### 1ë‹¨ê³„: ê¸°ì¡´ ë°ì´í„° ì™„ì „ ì‚­ì œ
```bash
# MongoDB ë°ì´í„° ì‚­ì œ
echo 'use recipe_ai_db
db.ingredients.deleteMany({})
db.recipes.deleteMany({})
db.vectormetadatas.deleteMany({})
db.chathistories.deleteMany({})' | mongosh --host 192.168.0.111:27017 --username recipe_admin --password 'RecipeDB_2024_Secure#9x7!' --authenticationDatabase admin

# Elasticsearch ì¸ë±ìŠ¤ ì‚­ì œ
curl -X DELETE "http://192.168.0.111:9200/recipe-ai-ingredients"
curl -X DELETE "http://192.168.0.111:9200/recipe-ai-recipes"
```

### 2ë‹¨ê³„: Elasticsearch ì¸ë±ìŠ¤ ì¬ìƒì„±
```bash
curl -X POST "http://localhost:3001/api/v1/indexing/setup-indices" -H "Content-Type: application/json"
```

### 3ë‹¨ê³„: allergen_ultra_clean.csv ë¡œë“œ
```bash
curl -X POST "http://localhost:3001/api/v1/indexing/load-ingredients" -H "Content-Type: application/json"
```
**ê²°ê³¼**: âœ… 15,244ê°œ ì¬ë£Œ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œ

### 4ë‹¨ê³„: RAW_recipes.csv ë¡œë“œ (Python ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©)

APIë¥¼ í†µí•œ ë¡œë“œì—ì„œ ì •ê·œì‹ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ Python ìŠ¤í¬ë¦½íŠ¸ë¡œ ì§ì ‘ ë¡œë“œ:

```python
import csv
import json
import ast
from pymongo import MongoClient
from datetime import datetime
import re

# MongoDB ì—°ê²°
client = MongoClient('mongodb://recipe_admin:RecipeDB_2024_Secure%239x7%21@192.168.0.111:27017/recipe_ai_db?authSource=admin')
db = client.recipe_ai_db

def safe_eval(text):
    """ì•ˆì „í•˜ê²Œ ë¬¸ìì—´ì„ íŒŒì´ì¬ ê°ì²´ë¡œ ë³€í™˜"""
    try:
        if text and text.strip():
            text = text.replace("'", '"')
            return json.loads(text)
        return []
    except:
        return []

# CSV íŒŒì¼ ì½ê¸° ë° ë°°ì¹˜ ì²˜ë¦¬
with open('/Users/choeseonghyeon/smart-recipe-chatbot/data/RAW_recipes.csv', 'r', encoding='utf-8') as file:
    reader = csv.DictReader(file)
    batch = []
    batch_size = 1000
    
    for row in reader:
        recipe = {
            'name': row['name'].strip(),
            'id': int(row['id']) if row['id'] else 0,
            'minutes': int(row['minutes']) if row['minutes'] else 0,
            'contributor_id': int(row['contributor_id']) if row['contributor_id'] else 0,
            'submitted': row['submitted'],
            'tags': safe_eval(row['tags']),
            'nutrition': safe_eval(row['nutrition']),
            'n_steps': int(row['n_steps']) if row['n_steps'] else 0,
            'steps': safe_eval(row['steps']),
            'description': row['description'].strip() if row['description'] else '',
            'ingredients': safe_eval(row['ingredients']),
            'n_ingredients': int(row['n_ingredients']) if row['n_ingredients'] else 0,
            'category': 'general',
            'difficulty': 'medium',
            'rating': 4.0 + (total_count % 10) / 10,
            'allergyInfo': {},
            'createdAt': datetime.utcnow(),
            'updatedAt': datetime.utcnow()
        }
        
        batch.append(recipe)
        
        if len(batch) >= batch_size:
            db.recipes.insert_many(batch, ordered=False)
            batch = []
```

**ê²°ê³¼**: âœ… 231,637ê°œ ë ˆì‹œí”¼ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œ

---

## ğŸ¯ ìµœì¢… ê²°ê³¼

### ë°ì´í„° ë¡œë“œ í˜„í™©
```bash
curl -X GET "http://localhost:3001/api/v1/indexing/status"
```

**ìµœì¢… ìƒíƒœ**:
```json
{
  "mongodb": {
    "recipes": 231637,
    "ingredients": 15244
  },
  "elasticsearch": {
    "recipes": 0,
    "ingredients": 15244
  },
  "synchronized": {
    "recipes": false,
    "ingredients": true
  }
}
```

### ìƒ˜í”Œ ë°ì´í„° ê²€ì¦

**ì¬ë£Œ ë°ì´í„° ìƒ˜í”Œ**:
```json
{
  "ingredient_name": "1% fat buttermilk",
  "ê¸€ë£¨í…í•¨ìœ ê³¡ë¬¼": 0,
  "ê°‘ê°ë¥˜": 0,
  "ìš°ìœ ": 1,
  "ê²¬ê³¼ë¥˜": 0,
  "note": "ìš°ìœ  ì„±ë¶„ í¬í•¨"
}
```

**ë ˆì‹œí”¼ ë°ì´í„° ìƒ˜í”Œ**:
```json
{
  "name": "arriba baked winter squash mexican style",
  "id": 137739,
  "minutes": 55,
  "ingredients": ["winter squash", "mexican seasoning", "mixed spice", "honey", "butter", "olive oil", "salt"],
  "steps": ["make a choice and proceed with recipe", "depending on size of squash, cut into half or fourths", ...],
  "nutrition": [51.5, 0.0, 13.0, 0.0, 2.0, 0.0, 4.0],
  "tags": ["60-minutes-or-less", "vegetarian", "mexican", "easy"]
}
```

---

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë°œìƒí•œ ì£¼ìš” ë¬¸ì œë“¤

#### 1. MongoDB URI íŒŒì‹± ì˜¤ë¥˜
**ë¬¸ì œ**: íŠ¹ìˆ˜ë¬¸ìê°€ í¬í•¨ëœ ë¹„ë°€ë²ˆí˜¸ë¡œ ì¸í•œ ì—°ê²° ì˜¤ë¥˜
```
MongoRuntimeError: Unable to parse recipe_admin:RecipeDB_2024_Secure with URL
```

**í•´ê²°**: URL ì¸ì½”ë”© ì ìš©
```bash
# ì›ë³¸: RecipeDB_2024_Secure#9x7!
# ì¸ì½”ë”©: RecipeDB_2024_Secure%239x7%21
MONGODB_URI='mongodb://recipe_admin:RecipeDB_2024_Secure%239x7%21@192.168.0.111:27017/recipe_ai_db?authSource=admin'
```

#### 2. MongoDB ì¤‘ë³µ í‚¤ ì˜¤ë¥˜
**ë¬¸ì œ**: 
```
E11000 duplicate key error collection: recipe_ai_db.ingredients index: ingredient_name_1 dup key
```

**í•´ê²°**: 
1. ê¸°ì¡´ ì¸ë±ìŠ¤ ì‚­ì œ: `db.ingredients.dropIndexes()`
2. ì¤‘ë³µ ë°ì´í„° ì œê±°
3. ê³ ìœ  ì œì•½ ì¡°ê±´ ì—†ì´ ë¡œë“œ

#### 3. MongoDB ì •ê·œì‹ ì˜¤ë¥˜
**ë¬¸ì œ**: ì¬ë£Œëª…ì˜ íŠ¹ìˆ˜ë¬¸ìë¡œ ì¸í•œ ì •ê·œì‹ ì˜¤ë¥˜
```
MongoServerError: Regular expression is invalid: missing terminating ] for character class
```

**í•´ê²°**: NestJS API ëŒ€ì‹  Python ìŠ¤í¬ë¦½íŠ¸ë¡œ ì§ì ‘ MongoDBì— ì‚½ì…

#### 4. TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜
**ë¬¸ì œ**: ë‹¤ì–‘í•œ íƒ€ì… ì˜¤ë¥˜ ë°œìƒ

**í•´ê²°**:
- Elasticsearch ëª¨ë“ˆì—ì„œ undefined íƒ€ì… ì²˜ë¦¬
- Redis ëª¨ë“ˆì—ì„œ íƒ€ì… ìºìŠ¤íŒ… ì ìš©
- IndexingServiceì—ì„œ any íƒ€ì… ì ìš©

#### 5. Elasticsearch ë²„ì „ í˜¸í™˜ì„± ë¬¸ì œ
**ë¬¸ì œ**: Python Elasticsearch í´ë¼ì´ì–¸íŠ¸ ë²„ì „ ë¶ˆì¼ì¹˜

**í•´ê²°**: ì§ì ‘ curl API ì‚¬ìš©ìœ¼ë¡œ ìš°íšŒ

---

## ğŸ“ˆ ì„±ê³¼ ë° í™œìš© ë°©ì•ˆ

### êµ¬ì¶•ëœ ë°ì´í„°ë² ì´ìŠ¤
- **ëŒ€ê·œëª¨ ë ˆì‹œí”¼ ë°ì´í„°**: 231,637ê°œ
- **ìƒì„¸ ì•Œë ˆë¥´ê¸° ì •ë³´**: 15,244ê°œ ì¬ë£Œ
- **ì™„ì „í•œ ë©”íƒ€ë°ì´í„°**: ì˜ì–‘ì •ë³´, íƒœê·¸, ì¡°ë¦¬ì‹œê°„ ë“±

### í™œìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥
1. **ğŸ” ê³ ê¸‰ ê²€ìƒ‰**: ì¬ë£Œ, ì•Œë ˆë¥´ê¸°, ì¡°ë¦¬ì‹œê°„ ê¸°ë°˜
2. **ğŸ¤– AI ì¶”ì²œ**: ë²¡í„° ìœ ì‚¬ì„± ê²€ìƒ‰
3. **âš¡ ì‹¤ì‹œê°„ ìë™ì™„ì„±**: Elasticsearch ê¸°ë°˜
4. **ğŸ¥ ì•Œë ˆë¥´ê¸° ê´€ë¦¬**: 19ê°€ì§€ ì•Œë ˆë¥´ê¸° ì •ë³´ í•„í„°ë§
5. **ğŸ“Š ì˜ì–‘ ë¶„ì„**: 7ê°€ì§€ ì˜ì–‘ì†Œ ì •ë³´

### ë‹¤ìŒ ë‹¨ê³„
- [ ] Elasticsearch ë ˆì‹œí”¼ ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ
- [ ] ë²¡í„° ì„ë² ë”© ìƒì„± ë° ì €ì¥
- [ ] í”„ë¡ íŠ¸ì—”ë“œ ê²€ìƒ‰ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
- [ ] AI ì¶”ì²œ ì‹œìŠ¤í…œ ê³ ë„í™”

---

## ğŸ“ ê´€ë ¨ ë…¸íŠ¸
- [[ë°±ì—”ë“œ ì•„í‚¤í…ì²˜ ì„¤ê³„]]
- [[API ì—”ë“œí¬ì¸íŠ¸ ì •ë¦¬]]
- [[Elasticsearch ì„¤ì • ê°€ì´ë“œ]]
- [[MongoDB ìŠ¤í‚¤ë§ˆ ì„¤ê³„]]
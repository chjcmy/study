# 프로세스 vs 스레드

---

## 프로세스 (Process)

### 정의와 구조

```
프로세스 = 실행 중인 프로그램 + 할당된 자원

프로그램: 디스크에 저장된 실행 파일 (정적)
프로세스: 메모리에 로드되어 실행 중 (동적)

PID 1234: FastAPI 서버
┌────────────────────────────────────┐
│  코드 영역 (Text)     ← 실행할 명령어 (읽기 전용)
│  데이터 영역 (Data)   ← 전역/정적 변수
│  BSS 영역             ← 초기화되지 않은 전역 변수
│  힙 (Heap)           ← 동적 할당 (malloc, new) ↓ 증가
│  ... (빈 공간) ...
│  스택 (Stack)         ← 지역 변수, 함수 호출   ↑ 증가
│  커널 영역             ← PCB, 파일 디스크립터
└────────────────────────────────────┘
```

### PCB (Process Control Block)

```
OS가 프로세스를 관리하기 위한 자료구조

PCB에 포함된 정보:
┌──────────────────────────────┐
│  PID: 1234                   │  프로세스 식별자
│  상태: Running               │  생성/준비/실행/대기/종료
│  PC: 0x7fff0040              │  다음 실행할 명령어 주소
│  레지스터 값들                │  CPU 레지스터 백업
│  메모리 관리 정보             │  페이지 테이블 포인터
│  I/O 상태: [fd 0, 1, 2, 5]   │  열린 파일들
│  스케줄링 정보: 우선순위=5    │  CPU 할당 관련
│  부모 PID: 1                 │  부모 프로세스
└──────────────────────────────┘
```

### 프로세스 상태 전이

```
                    ┌─────────┐
          생성 ────→│  준비    │←────────┐
                    │ (Ready)  │         │
                    └────┬─────┘         │
                    디스패치│              │ 타임아웃
                    (CPU 할당)            │(선점)
                    ┌────▼─────┐         │
                    │  실행    │─────────┘
                    │(Running) │
                    └────┬─────┘
                  I/O 요청│     │ 종료
                    ┌────▼─────┐│
                    │  대기    ││    ┌──────┐
                    │(Waiting) ││───→│ 종료  │
                    └────┬─────┘    │(Term) │
                  I/O 완료│          └──────┘
                         └──→ Ready
```

---

## 스레드 (Thread)

### 구조

```
프로세스 (FastAPI 서버)
┌────────────────────────────────────────┐
│  코드, 데이터, 힙, 파일 ← 모든 스레드 공유  │
│                                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐│
│  │ Thread 1 │ │ Thread 2 │ │ Thread 3 ││
│  │──────────│ │──────────│ │──────────││
│  │ 스택     │ │ 스택     │ │ 스택     ││  ← 각자 고유
│  │ PC       │ │ PC       │ │ PC       ││  ← 각자 고유
│  │ 레지스터  │ │ 레지스터  │ │ 레지스터  ││  ← 각자 고유
│  │ TID: 1   │ │ TID: 2   │ │ TID: 3   ││
│  └──────────┘ └──────────┘ └──────────┘│
└────────────────────────────────────────┘
```

### 스레드가 공유하는 것 / 고유한 것

| 공유 (Thread간) | 고유 (Thread별) |
|-----------------|----------------|
| 코드 영역 | **스택** |
| 데이터/BSS 영역 | **프로그램 카운터 (PC)** |
| 힙 영역 | **레지스터** |
| 파일 디스크립터 | **스레드 ID (TID)** |
| 시그널 핸들러 | 시그널 마스크 |

---

## 비교 정리

| 특성 | 프로세스 | 스레드 |
|------|---------|--------|
| 메모리 | 독립적 (격리) | 공유 (힙, 데이터) |
| 생성 비용 | 높음 (fork) | 낮음 (clone) |
| 전환 비용 | 높음 (TLB flush) | 낮음 |
| 통신 | IPC (파이프, 소켓, 공유 메모리) | 직접 변수 접근 |
| 안정성 | 하나 죽어도 다른 프로세스 안전 | 하나 죽으면 전체 프로세스 위험 |
| 동기화 | 불필요 (격리) | **필수** (Race Condition) |
| 디버깅 | 쉬움 (격리) | 어려움 (공유 상태) |

---

## 멀티프로세스 vs 멀티스레드

```
멀티프로세스 (uvicorn --workers 4)
┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
│ Worker 1 │ │ Worker 2 │ │ Worker 3 │ │ Worker 4 │
│ (PID 101)│ │ (PID 102)│ │ (PID 103)│ │ (PID 104)│
│ 독립 메모리│ │ 독립 메모리│ │ 독립 메모리│ │ 독립 메모리│
└──────────┘ └──────────┘ └──────────┘ └──────────┘
  장점: 안정적, CPU 코어 활용, GIL 우회
  단점: 메모리 많이 사용, IPC 필요

멀티스레드 (Java Spring)
┌────────────────────────────────────┐
│ 프로세스 (PID 101)                  │
│ ├── Thread-1 (요청 A)              │
│ ├── Thread-2 (요청 B)  ← 메모리 공유│
│ └── Thread-3 (요청 C)              │
└────────────────────────────────────┘
  장점: 가벼움, 빠른 통신, 자원 효율적
  단점: 동기화 문제, 하나 죽으면 전체 위험
```

### Python의 GIL (Global Interpreter Lock)

```
CPython의 GIL:
  한 번에 하나의 스레드만 Python 바이트코드 실행 가능!

Thread 1: [실행][대기][실행][대기]     ← GIL 획득/반납 반복
Thread 2: [대기][실행][대기][실행]

→ CPU 바운드: 멀티스레드 효과 없음! (진짜 병렬 안 됨)
→ I/O 바운드: 효과 있음 (I/O 대기 중 GIL 반납)

해결책:
  1. multiprocessing   → 프로세스별 별도 GIL
  2. asyncio           → 싱글 스레드 + 이벤트 루프 (FastAPI!)
  3. C 확장, Cython    → GIL 해제 가능
```

> **FastAPI**: 싱글 프로세스 + 이벤트 루프(비동기, GIL 문제 회피) + 멀티 워커(gunicorn)

---

## IPC (Inter-Process Communication)

```
프로세스 간 통신 방법:

1. 파이프 (Pipe)
   프로세스 A ──[파이프]──→ 프로세스 B (단방향)
   ls | grep ".py"

2. 소켓 (Socket)
   네트워크를 통한 통신 (TCP/UDP)
   FastAPI ←→ Cosmos DB

3. 공유 메모리 (Shared Memory)
   두 프로세스가 같은 메모리 영역 접근 (가장 빠름)
   동기화 필요 (세마포어)

4. 메시지 큐 (Message Queue)
   큐에 메시지를 넣고 꺼냄 (비동기 통신)
   
5. 시그널 (Signal)
   프로세스에 이벤트 알림 (SIGKILL, SIGTERM)
   kill -9 1234
```

---

## 면접 핵심 포인트

```
Q: 프로세스와 스레드의 차이?
A: 프로세스는 독립된 메모리 공간, 스레드는 프로세스 내에서 
   힙/코드/데이터를 공유하며 스택만 별도.
   → 스레드가 가벼우나 동기화 문제 있음.

Q: 멀티프로세스 vs 멀티스레드 선택 기준?
A: CPU 바운드(계산) → 멀티프로세스 (GIL 우회)
   I/O 바운드(네트워크) → 멀티스레드 또는 비동기
   Python → asyncio(FastAPI) 또는 multiprocessing

Q: 스레드 간 동기화 문제란?
A: Race Condition: 여러 스레드가 공유 자원에 동시 접근
   해결: Mutex(한 번에 하나), Semaphore(N개까지),
        atomic 연산, Lock-free 자료구조
```
